<link rel="import" href="elements.html">
<link rel="import" href="socobo-inventory-dropdown.html">

<dom-module id="socobo-inventory-create">
  <style>
    :host {
      display: block;
    }

    .create-dialog {
      --paper-dialog-button-color: var(--accent-color);
      --paper-dialog-title: {
        color: var(--text-primary-color);
      };
      min-height: 300px;
      padding: 8px;
    }

    .dialog-scrollable {
      @apply(--layout-vertical);
    }

    .count-input-area {
      @apply(--layout-horizontal);
    }

    .count-input-area .input {
      @apply(--layout-flex);
      margin-top: 8px;
    }

    .kind-dropdown {
      @apply(--layout-flex);
    }

    .input {
      min-width: 100px;
      max-width: 300px;
      --paper-input-container-color: var(--text-secondary-color);
      --paper-input-container-focus-color: var(--text-secondary-color);
      --paper-input-container-input-color: var(--text-secondary-color);
    }

    .kind-dropdown .input {
      margin: 0 0 16px 16px;
    }

    .measurement-input-area {
      @apply(--layout-horizontal);
      margin-right: 16px;
    }

    .measurement-input-area .add-button {
      margin: 8px 8px 8px 8px;
      background: var(--accent-color);
      color: var(--text-primary-color);
      height: 26px;
      width: 16px;
      padding: 2px;
    }

    .measurement-input-area .add-button .add-button-icon {
    }

    .create-dialog .buttons > * {
      margin: 8px;
    }

  </style>

  <template>
    <paper-dialog class="create-dialog" id="dialog">
      <h2>Neues Element anlegen</h2>
      <paper-dialog-scrollable>
        <div class="dialog-scrollable">
      <paper-input
        class="input"
        value="{{item.name}}"
        id="itemName"
        label="Bezeichnung"
        maxlength="30"
        minlength="5"
        auto-validate
        required
        auto-focus
        error-message="Bitte Bezeichnung eingeben"
        ></paper-input>
      <div class="layout-flex count-input-area">
        <paper-input
          pattern="[0-9]+"
          class="input"
          id="countInput"
          value="{{item.count}}"
          label="Menge/Anzahl"
          error-message="Zahl erforderlich"
          maxlength="5"
          minlength="1"
          auto-validate
          required></paper-input>
        <socobo-inventory-dropdown collection="[[measurementCollection]]" measurements="{{measurements}}" item="{{item}}">
        </socobo-inventory-dropdown>
      </div>
      <span>Haltbar bis</span>
      <paper-input type="date" class="input" value="{{item.bestBefore}}" id="bestBeforeInput"></paper-input>
      <div class="horizontal-section-container">
       <div class="horizontal-section">
      <paper-dropdown-menu label="Kategorie" id="categoryDropdown">
        <paper-menu class="dropdown-content" selected={{categoryDropdownIndex}}>
          <template is="dom-repeat" items="[[categories]]" as="category">
            <paper-item>[[category]]</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>
      </div>
      </div>
      </div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Abbrechen</paper-button>
        <paper-button on-click="_createItem">Ok</paper-button>
      </div>
    </paper-dialog>
    <firebase-collection id="fbMeasurements" location="{{measurementLocation}}" data="{{measurements}}"></firebase-collection>
  </template>
</dom-module>

<script>
  (function() {
    Polymer({
      is: 'socobo-inventory-create',
      measurementEmpty: true,
      properties: {
      },

      ready: function() {
        this.categories = [
        "Backen",
        "Gewürze",
        "Gemüse",
        "Obst"];

        this.measurementCollection = this.$.fbMeasurements;

        this.measurements = [];

        this.item = {};
        this.categoryDropdownIndex = 0;
        this.measurementDropdownIndex = 0;
      },

      /*Display the dialog
      @param {Object} userLogin
      */
      show: function(userLogin) {
        this.$.dialog.toggle();
        this.userLogin = userLogin;
        this.measurementLocation = "https://dazzling-inferno-402.firebaseio.com/" + "measurements/";

        // resetting the item
        this.item = {};
        this.$.bestBeforeInput.value = "";
        this.categoryDropdownIndex = 0;
        this.measurementDropdownIndex = 0;
        this.measurementEmpty = true;
      },

      _createItem: function() {
        this.item.measurement = this.$.measurementDropdown.selectedItemLabel;
        this.item.category = this.$.categoryDropdown.selectedItemLabel;

        if (!this.item.measurement) {
          alert("Maßangabe fehlt");
        } else {
          console.log(this.userLogin);
          var ref = new Firebase(this.userLogin.firebaseUrl + "inventory/" + this.userLogin.userId).push();
          this.item.id = ref.key();
          this.item.created = Firebase.ServerValue.TIMESTAMP;
          this.item.desc = this.item.name;
          this.item.info = this.item.count + " " + this.item.measurement;
          ref.set(this.item, this._creationCallback(this));
        }
      },

      _creationCallback: function(that) {
        return function(error)  {
          if (error) {
            alert("There was an error creating the item");
            console.log(error);
          } else {
            that.$.dialog.toggle();
            alert("Success!");
          }
        }
      }
    });
  })();
</script>
